{% extends "base.html" %}
{% block title %}{{ 'Edit' if editing else 'New' }} Schedule - PingBot{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="d-flex align-items-center mb-4">
            <a href="{{ url_for('messages.detail', message_id=message.id) }}" class="btn btn-sm btn-outline-secondary me-3">
                <i class="bi bi-arrow-left"></i>
            </a>
            <h4 class="mb-0">{{ 'Edit' if editing else 'New' }} Schedule for "{{ message.title }}"</h4>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <form method="POST">
                    {{ form.hidden_tag() }}

                    <div class="mb-3">
                        {{ form.frequency.label(class="form-label") }}
                        {{ form.frequency(class="form-select", id="freq-select") }}
                    </div>

                    <div class="row mb-3">
                        <div class="col">
                            {{ form.hour.label(class="form-label") }}
                            {{ form.hour(class="form-control", type="number", min=0, max=23) }}
                        </div>
                        <div class="col">
                            {{ form.minute.label(class="form-label") }}
                            {{ form.minute(class="form-control", type="number", min=0, max=59) }}
                        </div>
                    </div>

                    <div class="mb-3" id="dow-group" style="display:none;">
                        <label class="form-label">Days of Week</label>
                        <div class="d-flex flex-wrap gap-2" id="dow-checkboxes">
                            <div class="form-check">
                                <input class="form-check-input dow-cb" type="checkbox" value="1" id="dow-mon" checked>
                                <label class="form-check-label" for="dow-mon">Mon</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input dow-cb" type="checkbox" value="2" id="dow-tue">
                                <label class="form-check-label" for="dow-tue">Tue</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input dow-cb" type="checkbox" value="3" id="dow-wed">
                                <label class="form-check-label" for="dow-wed">Wed</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input dow-cb" type="checkbox" value="4" id="dow-thu">
                                <label class="form-check-label" for="dow-thu">Thu</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input dow-cb" type="checkbox" value="5" id="dow-fri">
                                <label class="form-check-label" for="dow-fri">Fri</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input dow-cb" type="checkbox" value="6" id="dow-sat">
                                <label class="form-check-label" for="dow-sat">Sat</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input dow-cb" type="checkbox" value="0" id="dow-sun">
                                <label class="form-check-label" for="dow-sun">Sun</label>
                            </div>
                        </div>
                        {{ form.days_of_week(type="hidden", id="days-of-week-input") }}
                    </div>

                    <div class="mb-3" id="dom-group" style="display:none;">
                        {{ form.day_of_month.label(class="form-label") }}
                        {{ form.day_of_month(class="form-control", type="number", min=1, max=31) }}
                    </div>

                    <div class="mb-3" id="custom-cron-group" style="display:none;">
                        {{ form.cron_expression.label(class="form-label") }}
                        {{ form.cron_expression(class="form-control", placeholder="0 9 * * 1-5", id="cron-input") }}
                        {% for error in form.cron_expression.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                        <div class="form-text">Standard 5-field cron: minute hour day month weekday</div>
                    </div>

                    <div class="mb-3">
                        {{ form.timezone.label(class="form-label") }}
                        {{ form.timezone(class="form-select") }}
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-muted">Preview</label>
                        <div id="cron-preview" class="bg-light rounded p-2 text-muted">â€”</div>
                    </div>

                    <div class="d-flex gap-2">
                        {{ form.submit(class="btn btn-primary") }}
                        <a href="{{ url_for('messages.detail', message_id=message.id) }}" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const freqSelect = document.getElementById('freq-select');
    const dowGroup = document.getElementById('dow-group');
    const domGroup = document.getElementById('dom-group');
    const customCronGroup = document.getElementById('custom-cron-group');
    const cronInput = document.getElementById('cron-input');
    const daysInput = document.getElementById('days-of-week-input');
    const preview = document.getElementById('cron-preview');

    function toggleGroups() {
        const freq = freqSelect.value;
        dowGroup.style.display = freq === 'weekly' ? 'block' : 'none';
        domGroup.style.display = freq === 'monthly' ? 'block' : 'none';
        customCronGroup.style.display = freq === 'custom' ? 'block' : 'none';
        updatePreview();
    }

    function updatePreview() {
        const freq = freqSelect.value;
        const h = document.getElementById('hour').value || '0';
        const m = document.getElementById('minute').value || '0';
        let desc = '';
        if (freq === 'daily') desc = `Every day at ${h.padStart(2,'0')}:${m.padStart(2,'0')}`;
        else if (freq === 'weekdays') desc = `Weekdays at ${h.padStart(2,'0')}:${m.padStart(2,'0')}`;
        else if (freq === 'weekly') {
            const days = getSelectedDays();
            const names = {0:'Sun',1:'Mon',2:'Tue',3:'Wed',4:'Thu',5:'Fri',6:'Sat'};
            const dayNames = days.map(d => names[d] || d).join(', ');
            desc = `Weekly on ${dayNames} at ${h.padStart(2,'0')}:${m.padStart(2,'0')}`;
        }
        else if (freq === 'monthly') {
            const dom = document.getElementById('day_of_month').value || '1';
            desc = `Monthly on day ${dom} at ${h.padStart(2,'0')}:${m.padStart(2,'0')}`;
        }
        else if (freq === 'custom') {
            desc = cronInput.value || 'Enter a cron expression';
        }
        preview.textContent = desc;
    }

    function getSelectedDays() {
        const cbs = document.querySelectorAll('.dow-cb:checked');
        return Array.from(cbs).map(cb => cb.value);
    }

    // Sync DOW checkboxes to hidden input before submit
    document.querySelector('form').addEventListener('submit', function() {
        if (freqSelect.value === 'weekly') {
            daysInput.value = getSelectedDays().join(',');
        }
    });

    freqSelect.addEventListener('change', toggleGroups);
    document.querySelectorAll('input').forEach(el => el.addEventListener('change', updatePreview));
    document.querySelectorAll('input').forEach(el => el.addEventListener('input', updatePreview));
    toggleGroups();
</script>
{% endblock %}
